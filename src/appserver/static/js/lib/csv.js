(function(){var f=["|","^"],m=[",",";","\t","|","^"],h=["\r\n","\r","\n"];function p(r){var s=typeof r;return s==="function"||s==="object"&&!!r}var k=Array.isArray||function(r){return toString.call(r)==="[object Array]"};function d(r){return typeof r==="string"}function o(r){return !isNaN(Number(r))}function e(r){return r==false||r==true}function b(r){return r==null}function q(r){return r!=null}function j(r,s){return q(r)?r:s}function l(u,s){for(var t=0,r=u.length;t<r;t+=1){if(s(u[t],t)===false){break}}}function a(r){return"attrs["+r+"]"}function g(s,r){if(o(s)){return"Number("+a(r)+")"}else{if(e(s)){return"Boolean("+a(r)+" == true)"}else{return"String("+a(r)+")"}}}function c(r,s,t){var u=[];if(arguments.length==2){if(r){if(k(r)){l(s,function(w,v){u.push(r[v]+"("+a(v)+")")})}else{l(s,function(w,v){u.push(g(w,v))})}}else{l(s,function(w,v){u.push(a(v))})}u="return ["+u.join(",")+"]"}else{if(r){if(k(r)){l(s,function(w,v){u.push('"'+t[v]+'": '+r[v]+"("+a(v)+")")})}else{l(s,function(w,v){u.push('"'+t[v]+'": '+g(w,v))})}}else{l(s,function(w,v){u.push('"'+t[v]+'": '+a(v))})}u="return {"+u.join(",")+"}"}return new Function("attrs",u)}function i(s,u){var t=0,r;l(u,function(v){var x=v,w;if(f.indexOf(v)!=-1){x="\\"+x}w=s.match(new RegExp(x,"g"));if(w&&w.length>t){t=w.length;r=v}});return(r||u[0])}var n=(function(){function u(y,v){if(!v){v={}}if(k(y)){this.mode="encode"}else{if(d(y)){this.mode="parse"}else{throw new Error("Incompatible format!")}}this.data=y;this.options={header:j(v.header,false),cast:j(v.cast,true)};var x=v.lineDelimiter||v.line,w=v.cellDelimiter||v.delimiter;if(this.isParser()){this.options.lineDelimiter=x||i(this.data,h);this.options.cellDelimiter=w||i(this.data,m);this.data=t(this.data,this.options.lineDelimiter)}else{if(this.isEncoder()){this.options.lineDelimiter=x||"\r\n";this.options.cellDelimiter=w||","}}}function s(x,w,v){x(new w(v))}function t(w,v){if(w.slice(-v.length)!=v){w+=v}return w}u.prototype.set=function(v,w){return this.options[v]=w};u.prototype.isParser=function(){return this.mode=="parse"};u.prototype.isEncoder=function(){return this.mode=="encode"};u.prototype.parse=function(D){if(this.mode!="parse"){return}if(this.data.trim().length===0){return[]}var O=this.data,B=this.options,K=B.header,I={cell:"",line:[]},J,z,w;if(!D){w=[];D=function(P){w.push(P)}}function N(){J={escaped:false,quote:false,cell:true}}function y(){I.cell=""}function F(){I.line=[]}function L(P){I.line.push(J.escaped?P.slice(1,-1).replace(/""/g,'"'):P);y();N()}function G(P){L(P.slice(0,1-B.lineDelimiter.length))}function A(){if(K){if(k(K)){z=c(B.cast,I.line,K);A=function(){s(D,z,I.line)};A()}else{K=I.line}}else{if(!z){z=c(B.cast,I.line)}A=function(){s(D,z,I.line)};A()}}if(B.lineDelimiter.length==1){G=L}var E=O.length,M=B.cellDelimiter.charCodeAt(0),H=B.lineDelimiter.charCodeAt(B.lineDelimiter.length-1),x,C,v;N();for(x=0,C=0;x<E;x++){v=O.charCodeAt(x);if(J.cell){J.cell=false;if(v==34){J.escaped=true;continue}}if(J.escaped&&v==34){J.quote=!J.quote;continue}if((J.escaped&&J.quote)||!J.escaped){if(v==M){L(I.cell+O.slice(C,x));C=x+1}else{if(v==H){G(I.cell+O.slice(C,x));C=x+1;A();F()}}}}if(w){return w}else{return this}};function r(v){if(k(v)){return"array"}else{if(p(v)){return"object"}else{if(d(v)){return"string"}else{if(b(v)){return"null"}else{return"primitive"}}}}}u.prototype.serialize={object:function(w){var x=this,v=Object.keys(w),y=Array(v.length);l(v,function(z,A){y[A]=x[r(w[z])](w[z])});return y},array:function(x){var v=this,w=Array(x.length);l(x,function(z,y){w[y]=v[r(z)](z)});return w},string:function(v){return'"'+String(v).replace(/"/g,'""')+'"'},"null":function(v){return""},primitive:function(v){return v}};u.prototype.encode=function(E){if(this.mode!="encode"){return}if(this.data.length==0){return""}var B=this.data,G=this.options,C=G.header,D=B[0],F=this.serialize,z=0,A,y;if(!E){y=Array(B.length);E=function(H,I){y[I+z]=H}}function w(H){return H.join(G.cellDelimiter)}if(C){if(!k(C)){A=Object.keys(D);C=A}E(w(F.array(C)),0);z=1}var x=r(D),v;if(x=="array"){if(k(G.cast)){v=Array(G.cast.length);l(G.cast,function(I,H){v[H]=I.toLowerCase()})}else{v=Array(D.length);l(D,function(I,H){v[H]=r(I)})}l(B,function(H,J){var I=Array(v.length);l(H,function(K,L){I[L]=F[v[L]](K)});E(w(I),J)})}else{if(x=="object"){A=Object.keys(D);if(k(G.cast)){v=Array(G.cast.length);l(G.cast,function(I,H){v[H]=I.toLowerCase()})}else{v=Array(A.length);l(A,function(H,I){v[I]=r(D[H])})}l(B,function(H,J){var I=Array(A.length);l(A,function(K,L){I[L]=F[v[L]](H[K])});E(w(I),J)})}}if(y){return y.join(G.lineDelimiter)}else{return this}};u.prototype.forEach=function(v){return this[this.mode](v)};return u})();n.parse=function(s,r){return new n(s,r).parse()};n.encode=function(s,r){return new n(s,r).encode()};n.forEach=function(s,r,t){if(arguments.length==2){t=r}return new n(s,r).forEach(t)};window.CSV=n})();