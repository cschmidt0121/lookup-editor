require.config({paths:{text:"../app/lookup_editor/js/lib/text",console:"../app/lookup_editor/js/lib/console",kv_store_field_view:"../app/lookup_editor/js/views/KVStoreFieldView"}});define(["underscore","backbone","splunkjs/mvc","util/splunkd_utils","jquery","splunkjs/mvc/simplesplunkview","kv_store_field_view","text!../app/lookup_editor/js/templates/KVStoreFieldEditor.html","css!../app/lookup_editor/css/KVStoreFieldEditor.css"],function(i,h,a,b,c,f,e,d){var g=f.extend({className:"KVStoreFieldEditor",defaults:{default_field_count:5},events:{"click .add-additional-field":"doAddField"},initialize:function(){this.options=i.extend({},this.defaults,this.options);this.field_views=[];this.field_counter=0;this.default_field_count=this.options.default_field_count;this.listenTo(h,"kv_field:remove",this.removeField.bind(this))},validate:function(){var o=false;for(var q=0;q<this.field_views.length;q++){if(this.field_views[q].hasFieldName()){o=true}this.field_views[q].hideErrorMessage()}if(!o){return"At least one field needs to be defined"}var n=[];var l=null;var k=null;for(q=0;q<this.field_views.length;q++){if(this.field_views[q].hasFieldName()){l=this.field_views[q].getFieldName().split(".").slice(0,-1);k=null;for(var p=0;p<l.length;p++){if(k===null){k=l[p]}else{k=k+"."+l[p]}n.push(k)}}}var j=false;for(q=0;q<this.field_views.length;q++){for(var p=0;p<n.length;p++){if(n[p]===this.field_views[q].getFieldName()){this.field_views[q].showErrorMessage("This field's name cannot co-exist with another field that has '"+n[p]+'" in its name');j=true;return'The field "'+this.field_views[q].getFieldName()+'" cannot be used'}}}var m=false;for(q=0;q<this.field_views.length;q++){for(var p=0;p<this.field_views.length;p++){if(q!==p&&this.field_views[q].hasFieldName()){if(this.field_views[q].getFieldName()===this.field_views[p].getFieldName()){this.field_views[q].showErrorMessage("Another field has this name already");this.field_views[p].showErrorMessage("Another field has this name already");m=true}}}}if(m){return"Fields cannot have the same name"}return true},removeField:function(j){this.field_views=i.without(this.field_views,i.findWhere(this.field_views,{unique_identifier:j}))},doAddField:function(){this.addFieldView("","string")},addFieldView:function(l,m){var k="kv_store_field_"+this.field_counter;c('<div id="'+k+'"></div>').appendTo("#kv-store-fields");var j=new e({el:c("#"+k,this.$el),unique_identifier:k});this.field_views.push(j);j.render();this.field_counter++},modifyKVStoreLookupSchema:function(k,l,j,o){if(typeof j=="undefined"){j="nobody"}if(typeof o=="undefined"){o=null}var m={};for(var n=0;n<this.field_views.length;n++){if(this.field_views[n].hasFieldName()){m["field."+this.field_views[n].getFieldName()]=this.field_views[n].getFieldType()}}m.replicate="true";c.ajax({url:b.fullpath(["/servicesNS",j,k,"storage/collections/config",l].join("/")),data:m,type:"POST",success:function(p){console.info("KV store lookup file created");this.lookup=l;this.namespace=k;this.owner=j;this.lookup_type="kv";if(o){o()}}.bind(this),complete:function(p,q){if(p.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to make a KV store collection",true)}}.bind(this),error:function(p,r,q){if(p.status!=403){console.info("KV store collection creation failed");this.showWarningMessage("The KV store collection could not be created",true)}}.bind(this)})},render:function(){this.$el.html(i.template(d,{}));var j={};for(var k in j){this.addFieldView(k,j[k])}if(this.field_views.length===0){for(var l=0;l<this.default_field_count;l++){this.addFieldView("","string")}}}});return g});