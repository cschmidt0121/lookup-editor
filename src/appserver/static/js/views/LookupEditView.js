require.config({paths:{Handsontable:"../app/lookup_editor/js/lib/handsontable.full.min",text:"../app/lookup_editor/js/lib/text",console:"../app/lookup_editor/js/lib/console",csv:"../app/lookup_editor/js/lib/csv",kv_store_field_editor:"../app/lookup_editor/js/views/KVStoreFieldEditor"},shim:{Handsontable:{deps:["jquery"]}}});define(["underscore","backbone","models/SplunkDBase","collections/SplunkDsBase","splunkjs/mvc","util/splunkd_utils","jquery","splunkjs/mvc/simplesplunkview","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simpleform/input/checkboxgroup","text!../app/lookup_editor/js/templates/LookupEdit.html","kv_store_field_editor","csv","Handsontable","bootstrap.dropdown","splunk.util","css!../app/lookup_editor/css/LookupEdit.css","css!../app/lookup_editor/css/lib/handsontable.full.min.css"],function(r,a,c,l,k,d,f,q,b,g,j,s,o){var h=l.extend({url:"apps/local?count=-1&search=disabled%3D0",initialize:function(){l.prototype.initialize.apply(this,arguments)}});var e=c.extend({initialize:function(){c.prototype.initialize.apply(this,arguments)}});var n=a.Model.extend();var m=a.Collection.extend({url:Splunk.util.make_full_url("/splunkd/__raw/services/lookup_editor/get_lookup_backups_list"),model:n});var p=q.extend({className:"LookupEditView",defaults:{},initialize:function(){this.options=r.extend({},this.defaults,this.options);this.backups=null;this.lookup=null;this.namespace=null;this.owner=null;this.lookup_type=null;this.lookup_config=null;this.field_types={};this.field_types_enforced=false;this.is_read_only=false;this.table_header=null;this.kv_store_fields_editor=null;this.forgiving_checkbox_editor=null;this.apps=new h();this.apps.on("reset",this.gotApps.bind(this),this);this.apps.fetch({success:function(){console.info("Successfully retrieved the list of applications")},error:function(){console.error("Unable to fetch the apps")}});this.is_new=true;this.info_message_posted_time=null;setInterval(this.hideInfoMessageIfNecessary.bind(this),1000);this.listenTo(a,"kv_field:changed",this.validateForm.bind(this))},events:{"click #save":"doSaveLookup","click .backup-version":"doLoadBackup","click #choose-import-file":"chooseImportFile","click #import-file":"openFileImportModal","change #import-file-input":"importFile","dragenter #lookup-table":"onDragFileEnter","dragleave #lookup-table":"onDragFileEnd"},hideInfoMessageIfNecessary:function(){if(this.info_message_posted_time&&((this.info_message_posted_time+5000)<new Date().getTime())){this.info_message_posted_time=null;f("#info-message",this.$el).fadeOut(200)}},setupDragDropHandlers:function(){var t=document.getElementById("lookup-table");this.setupDragDropHandlerOnElement(t);drop_zone2=document.getElementById("import-file-modal");this.setupDragDropHandlerOnElement(drop_zone2)},setupDragDropHandlerOnElement:function(t){t.ondragover=function(u){u.preventDefault();u.dataTransfer.dropEffect="copy"}.bind(this);t.ondrop=function(u){u.preventDefault();this.onDropFile(u);return false}.bind(this)},getFieldForColumn:function(t){var u=this.getTableHeader();return u[t]},getTableHeader:function(t){if(typeof t==="undefined"){t=true}if(t&&this.table_header!==null){return this.table_header}if(this.lookup_type==="csv"){this.table_header=handsontable.getDataAtRow(0)}else{this.table_header=f("#lookup-table").data("handsontable").getColHeader()}return this.table_header},getColumnForField:function(t){var u=this.getTableHeader();for(var v=0;v<u.length;v++){if(u[v]===t){return v}}console.warn('Unable to find the field with the name "'+t+'"');return null},isCellTypeInvalid:function(z,t,w){if(!this.field_types_enforced){return false}var v=f("#lookup-table").data("handsontable");var y=this.getTableHeader();var u=y[t];if(u in this.field_types){var x=this.field_types[u];if(x==="number"&&!/^[-]?\d+$/.test(w)){return true}else{if(x==="boolean"&&!/^(true)|(false)$/.test(w)){return true}}}return false},lookupRenderer:function(t,A,y,u,z,w,v){if(w===null){A.innerHTML=this.escapeHtml("")}else{A.innerHTML=this.escapeHtml(w)}var x=false;if(w){x=(typeof w.toLowerCase==="function")}if(y!==0&&this.isCellTypeInvalid(y,u,w)){A.className="cellInvalidType"}else{if(!w||w===""){A.className="cellEmpty"}else{if(this.getFieldForColumn(u)==="_key"){A.className="cellKey"}else{if(parseFloat(w)<0){A.className="cellNegative"}else{if(String(w).substring(0,7)=="http://"||String(w).substring(0,8)=="https://"){A.className="cellHREF"}else{if(parseFloat(w)>0){A.className="cellPositive"}else{if(y===0&&this.lookup_type==="csv"){A.className="cellHeader"}else{if(w!==null&&x&&w.toLowerCase()==="true"){A.className="cellTrue"}else{if(w!==null&&x&&w.toLowerCase()==="false"){A.className="cellFalse"}else{if(w!==null&&x&&w.toLowerCase()==="unknown"){A.className="cellUrgencyUnknown"}else{if(w!==null&&x&&w.toLowerCase()==="informational"){A.className="cellUrgencyInformational"}else{if(w!==null&&x&&w.toLowerCase()==="low"){A.className="cellUrgencyLow"}else{if(w!==null&&x&&w.toLowerCase()==="medium"){A.className="cellUrgencyMedium"}else{if(w!==null&&x&&w.toLowerCase()==="high"){A.className="cellUrgencyHigh"}else{if(w!==null&&x&&w.toLowerCase()==="critical"){A.className="cellUrgencyCritical"}else{A.className=""}}}}}}}}}}}}}}}if(v.readOnly){A.style.opacity=0.7}},openFileImportModal:function(){f(".dragging").removeClass("dragging");f("#import-file-modal",this.$el).modal();f(".modal-backdrop").on("dragenter",function(){f(".modal-body").addClass("dragging");console.log("enter")});f(".modal-backdrop").on("dragleave",function(){f(".modal-body").removeClass("dragging");console.log("leave")});f("#import-file-modal").on("dragenter",function(){f(".modal-body").addClass("dragging");console.log("enter")})},chooseImportFile:function(){f("#import-file-input").click()},loadBackupFile:function(t){if(typeof t=="undefined"){t=null}var u=confirm("This version the lookup file will now be loaded.\n\nUnsaved changes will be overridden.");if(u==true){this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type,false,t);return true}else{return false}},hideWarningMessage:function(){this.hide(f("#warning-message",this.$el))},hideInfoMessage:function(){this.hide(f("#info-message",this.$el))},hideMessages:function(){this.hideWarningMessage();this.hideInfoMessage()},showWarningMessage:function(t){f("#warning-message > .message",this.$el).text(t);this.unhide(f("#warning-message",this.$el))},showInfoMessage:function(t){f("#info-message > .message",this.$el).text(t);this.unhide(f("#info-message",this.$el));this.info_message_posted_time=new Date().getTime()},loadLookupBackupsList:function(v,u,t){var w={lookup_file:v,namespace:u};if(typeof t==="undefined"){t=null}if(t!==null){w.owner=t}this.backups=new m();this.backups.fetch({data:f.param(w),success:this.renderBackupsList.bind(this)})},onDragFile:function(t){t.stopPropagation();t.preventDefault();t.dataTransfer.dropEffect="copy"},onDragFileEnter:function(t){t.preventDefault();return false},onDragFileEnd:function(){console.log("Dragging stopped");this.$el.removeClass("dragging")},onDropFile:function(t){console.log("Got a file via drag and drop");t.stopPropagation();t.preventDefault();var u=t.dataTransfer.files;this.importFile(t)},escapeHtml:function(t){var u=document.createElement("div");u.appendChild(document.createTextNode(t));return u.innerHTML},importFile:function(u){if(this.lookup_type!=="csv"){this.showWarningMessage("Drag & drop importing on KV store lookups is not currently supported");console.info("Drag and dropping on a KV store lookup being ignored");return false}if(this.read_only){console.info("Drag and dropping on a read-only lookup being ignored");return false}if(!window.FileReader){alert("Your browser doesn't support file reading in Javascript; thus, I cannot parse your uploaded file");return false}var t=new FileReader();t.onload=function(x){console.log("Running file reader onload handler");if(x.target.readyState!=2){return}if(x.target.error){f(".table-loading-message").hide();this.showWarningMessage("Unable to import the file");return}var w=x.target.result;var y=new CSV(w,{}).parse();this.renderLookup(y);f("#import-file-modal",this.$el).modal("hide");this.showInfoMessage("File imported successfully")}.bind(this);var v=[];if(u.target.files&&u.target.files.length>0){v=u.target.files}else{if(u.dataTransfer&&u.dataTransfer.files.length>0){v=u.dataTransfer.files}}if(v.length>0){if(this.is_new&&(!k.Components.getInstance("lookup-name").val()||k.Components.getInstance("lookup-name").val().length<=0)){k.Components.getInstance("lookup-name").val(v[0].name)}t.readAsText(v[0])}else{f(".table-loading-message").hide()}},renderBackupsList:function(){var t='<a class="btn active btn-primary dropdown-toggle" data-toggle="dropdown" href="#">         			Revert to previous version         			<span class="caret"></span>         		</a>         		<ul class="dropdown-menu">         		<% for(var c = 0; c < backups.length; c++){ %>         			<li><a class="backup-version" href="#" data-backup-time="<%- backups[c].time %>"><%- backups[c].time_readable %></a></li>         		<% } %>         		<% if(backups.length == 0){ %>         			<li><a class="backup-version" href="#">No backup versions available</a></li>         		<% } %>         	</ul>';f("#load-backup",this.$el).html(r.template(t,{backups:this.backups.toJSON()}));if(this.read_only!==true){f("#load-backup",this.$el).show()}else{f("#load-backup",this.$el).hide()}},makeKVStoreLookup:function(u,v,t){if(typeof t=="undefined"){t="nobody"}var w={name:v};f.ajax({url:d.fullpath(["/servicesNS",t,u,"storage/collections/config"].join("/")),data:w,type:"POST",success:function(x){console.info("KV store lookup file created");this.lookup=v;this.namespace=u;this.owner=t;this.lookup_type="kv";this.kv_store_fields_editor.modifyKVStoreLookupSchema(this.namespace,this.lookup,"nobody",function(){this.showInfoMessage("Lookup created successfully");document.location="?lookup="+v+"&owner="+t+"&type=kv&namespace="+u}.bind(this))}.bind(this),complete:function(x,y){if(x.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to make a KV store collection",true)}else{if(x.status==409){console.info("Lookup name already exists");f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Lookup name already exists, please select another")}}this.setSaveButtonTitle()}.bind(this),error:function(x,z,y){if(x.status!=403&&x.status!=409){console.info("KV store collection creation failed");this.showWarningMessage("The KV store collection could not be created",true)}}.bind(this)})},loadLookupContents:function(x,w,u,z,v,t){if(typeof v=="undefined"){v=false}var y={lookup_file:x,namespace:w,header_only:v,lookup_type:z};if(typeof t=="undefined"){t=undefined}f(".table-loading-message").show();if(t!==undefined&&t){y.version=t}if(u!==null){y.owner=u}url=Splunk.util.make_full_url("/splunkd/__raw/services/lookup_editor/get_lookup_contents",y);var A=new Date().getTime();f.ajax({url:url,cache:false,success:function(C){if(C==null||C.length===0){console.error("JSON of lookup table could not be loaded (got an empty value)");this.showWarningMessage("The requested lookup file could not be loaded",true);f(".show-when-editing",this.$el).hide()}else{console.info("JSON of lookup table was successfully loaded");this.renderLookup(C);var B=new Date().getTime()-A;console.info("Lookup loaded and rendered in "+B+"ms");this.lookup=x;this.namespace=w;this.owner=u;this.lookup_type=z}}.bind(this),complete:function(B,C){if(B.status==404){console.info("Lookup file was not found");this.showWarningMessage("The requested lookup file does not exist",true)}else{if(B.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to view this lookup file",true)}else{if(B.status==420){console.info("File is too large");this.showWarningMessage("The file is too big to be edited (must be less than 10 MB)")}}}f(".table-loading-message").hide();if(t===undefined&&this.lookup_type==="csv"){this.loadLookupBackupsList(x,w,u)}else{if(this.lookup_type==="csv"){this.showInfoMessage("Backup file was loaded successfully")}}}.bind(this),error:function(B,D,C){if(B.status!=404&&B.status!=403&&B.status!=420){console.info("Lookup file could not be loaded");this.showWarningMessage("The lookup could not be loaded from the server",true)}this.read_only=true;this.hideEditingControls()}.bind(this)})},hideEditingControls:function(t){if(typeof t==="undefined"){t=true}if(t){f(".btn",this.$el).hide()}else{f(".btn",this.$el).show()}},validate:function(t){if(t[0][0]===0&&t[0][3].length===0){return false}},validateForm:function(){var u=0;f("#lookup-name-control-group",this.$el).removeClass("error");f("#lookup-app-control-group",this.$el).removeClass("error");this.hideWarningMessage();if(this.is_new&&(!k.Components.getInstance("lookup-name").val()||k.Components.getInstance("lookup-name").val().length<=0)){f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Please enter a lookup name");u=u+1}else{if(this.is_new&&!k.Components.getInstance("lookup-name").val().match(/^[-A-Z0-9_ ]+([.][-A-Z0-9_ ]+)*$/gi)){f("#lookup-name-control-group",this.$el).addClass("error");this.showWarningMessage("Lookup name is invalid");u=u+1}}if(this.is_new&&(!k.Components.getInstance("lookup-app").val()||k.Components.getInstance("lookup-app").val().length<=0)){f("#lookup-app-control-group",this.$el).addClass("error");this.showWarningMessage("Select the app where the lookup will reside");u=u+1}if(this.is_new&&this.lookup_type==="kv"){var t=this.kv_store_fields_editor.validate();if(t!==true){this.showWarningMessage(t);u=u+1}}if(u>0){return false}else{return true}},getAppsChoices:function(){if(!this.apps){return[]}var u=[];for(var t=0;t<this.apps.models.length;t++){u.push({label:this.apps.models[t].entry.associated.content.attributes.label,value:this.apps.models[t].entry.attributes.name})}return u},gotApps:function(){if(k.Components.getInstance("lookup-app")){k.Components.getInstance("lookup-app").settings.set("choices",this.getAppsChoices())}},setSaveButtonTitle:function(t){if(typeof t=="undefined"){f("#save").text("Save Lookup")}else{f("#save").text(t)}},pad:function(t,u){var v=t+"";while(v.length<u){v="0"+v}return v},updateTimeModified:function(){var t=new Date();var u=t.getHours()>12?"PM":"AM";f("#modification-time").text("Modified: "+t.getFullYear()+"/"+this.pad(t.getMonth()+1,2)+"/"+t.getDate()+" "+this.pad((t.getHours()%12),2)+":"+this.pad(t.getMinutes(),2)+":"+this.pad(t.getSeconds(),2)+" "+u);f(".modification-time-holder > i").show();f(".modification-time-holder > i").fadeOut(1000)},doLoadBackup:function(u){var t=u.currentTarget.dataset.backupTime;if(t){this.loadBackupFile(t)}},doSaveLookup:function(t){var w=this.is_new;this.setSaveButtonTitle("Saving...");var x=new Date().getTime();this.hideMessages();if(!this.validateForm()){this.setSaveButtonTitle();return}if(w&&this.lookup_type==="kv"){this.makeKVStoreLookup(k.Components.getInstance("lookup-app").val(),k.Components.getInstance("lookup-name").val())}else{var u=f("#lookup-table").data("handsontable");row_data=u.getData();json=JSON.stringify(row_data);var v={lookup_file:this.lookup,namespace:this.namespace,contents:json};if(this.owner!==null){v.owner=this.owner}if(w){v.lookup_file=k.Components.getInstance("lookup-name").val();if(v.lookup_file===""){f("#lookup_file_error").text("Please define a file name");f("#lookup_file_error").show();this.setSaveButtonTitle();return false}if(!v.lookup_file.match(/^[-A-Z0-9_ ]+([.][-A-Z0-9_ ]+)*$/gi)){f("#lookup_file_error").text("The file name contains invalid characters");f("#lookup_file_error").show();this.setSaveButtonTitle();return false}v.namespace=k.Components.getInstance("lookup-app").val();if(v.namespace===""){f("#lookup_namespace_error").text("Please define a namespace");f("#lookup_namespace_error").show();this.setSaveButtonTitle();return false}if(f.inArray("user_only",k.Components.getInstance("lookup-user-only").val())>=0){v.owner=Splunk.util.getConfigValue("USERNAME")}}if(row_data.length===0){this.showWarningMessage("Lookup files must contain at least one row (the header)");return false}for(i=0;i<row_data[0].length;i++){if(row_data[0][i]===""){this.showWarningMessage("Header rows cannot contain empty cells (column "+(i+1)+" of the header is empty)");return false}}f.ajax({url:Splunk.util.make_url("/splunkd/__raw/services/lookup_editor/save"),type:"POST",data:v,success:function(){console.log("Lookup file saved successfully");this.showInfoMessage("Lookup file saved successfully");this.setSaveButtonTitle();if(this.is_new){this.lookup=v.lookup_file;this.namespace=v.namespace;this.owner=v.owner;this.lookup_type="csv"}}.bind(this),complete:function(z,B){var y=new Date().getTime()-x;console.info("Lookup save operation completed in "+y+"ms");var A=true;if(z.status==404){console.info("Lookup file was not found");this.showWarningMessage("This lookup file could not be found");A=false}else{if(z.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup file");A=false}else{if(z.status==400){console.info("Invalid input");this.showWarningMessage("This lookup file could not be saved because the input is invalid");A=false}else{if(z.status==500){this.showWarningMessage("The lookup file could not be saved");A=false}}}}this.setSaveButtonTitle();if(this.is_new&&A){this.changeToEditMode()}if(A){this.loadLookupBackupsList(this.lookup,this.namespace,this.owner)}}.bind(this),error:function(y,A,z){console.log("Lookup file not saved");this.showWarningMessage("Lookup file could not be saved")}.bind(this)})}return false},doEditCell:function(A,u,v){if(this.read_only){return}var y=f("#lookup-table").data("handsontable");var x=y.getDataAtRow(A);var w=x[this.getColumnForField("_key")];if(w===undefined){console.error("Unable to get the _key for editing the cell at ("+A+", "+u+")");return}var z=this.makeRowJSON(A);var t=Splunk.util.make_url("/splunkd/servicesNS/"+this.owner+"/"+this.namespace+"/storage/collections/data/"+this.lookup+"/"+w);if(!w){t=Splunk.util.make_url("/splunkd/servicesNS/"+this.owner+"/"+this.namespace+"/storage/collections/data/"+this.lookup)}f.ajax({url:t,type:"POST",dataType:"json",data:JSON.stringify(z),contentType:"application/json; charset=utf-8",success:function(B){this.hideWarningMessage();if(!w){w=B._key;y.setDataAtCell(A,this.getColumnForField("_key"),w,"key_update");console.info("KV store entry creation completed for entry "+w)}else{console.info("KV store entry edit completed for entry "+w)}this.updateTimeModified()}.bind(this),complete:function(B,C){if(B.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}}.bind(this),error:function(B,D,C){this.showWarningMessage("Entry could not be saved to the KV store lookup; make sure the value matches the expected type",true)}.bind(this)})},doRemoveRow:function(w){if(this.read_only){return}var v=f("#lookup-table").data("handsontable");var u=v.getDataAtRow(w);var t=u[0];f.ajax({url:Splunk.util.make_url("/splunkd/servicesNS/"+this.owner+"/"+this.namespace+"/storage/collections/data/"+this.lookup+"/"+t),type:"DELETE",success:function(x){console.info("KV store entry removal completed for entry "+t);this.hideWarningMessage();this.updateTimeModified()}.bind(this),complete:function(x,y){if(x.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}}.bind(this),error:function(x,z,y){this.showWarningMessage("An entry could not be removed from the KV store lookup",true)}.bind(this)})},addFieldToJSON:function(u,v,t){var w=[];w=v.split(".");if(w.length>1){if(!(w[0] in u)){u[w[0]]={}}return this.addFieldToJSON(u[w[0]],w.slice(1).join("."),t)}else{u[v]=t;return u}},makeRowJSON:function(x){var u=f("#lookup-table").data("handsontable");var w=this.getTableHeader();var t=u.getDataAtRow(x);var v={};for(var y=1;y<w.length;y++){this.addFieldToJSON(v,w[y],(t[y]===undefined?"":t[y]))}return v},doCreateRows:function(w,u){if(this.read_only){return}var t=f("#lookup-table").data("handsontable");var v=[];for(var x=0;x<u;x++){v.push(this.makeRowJSON(w+x))}f.ajax({url:Splunk.util.make_url("/splunkd/servicesNS/"+this.owner+"/"+this.namespace+"/storage/collections/data/"+this.lookup+"/batch_save"),type:"POST",dataType:"json",data:JSON.stringify(v),contentType:"application/json; charset=utf-8",success:function(y){for(var z=0;z<y.length;z++){t.setDataAtCell(w+z,this.getColumnForField("_key"),y[z],"key_update")}this.hideWarningMessage();this.updateTimeModified()}.bind(this),complete:function(y,z){if(y.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to edit this lookup",true)}}.bind(this),error:function(y,A,z){}.bind(this)})},getColumnsMetadata:function(){if(!this.getTableHeader()){console.warn("The table header is not available yet")}var u=this.getTableHeader();var w=null;var v=[];if(!this.field_types){console.warn("The table field types are not available yet")}var t=null;for(var x=0;x<u.length;x++){t=this.field_types[u[x]];w={};if(t==="boolean"){w.type="checkbox";w.editor=this.getCheckboxRenderer()}else{if(t==="time"){}}v.push(w)}return v},reRenderHandsOnTable:function(){if(f("#lookup-table").length>0&&f("#lookup-table").data("handsontable")){var t=f("#lookup-table").data("handsontable");if(t){t.render()}}},addEmptyRows:function(t,x,u){var v=[];for(var w=0;w<x;w++){v.push("")}for(w=0;w<u;w++){t.push(f.extend(true,[],v))}},getCheckboxRenderer:function(){if(this.forgiving_checkbox_editor!==null){return this.forgiving_checkbox_editor}this.forgiving_checkbox_editor=Handsontable.editors.CheckboxEditor.prototype.extend();this.forgiving_checkbox_editor.prototype.prepare=function(w,u,y,x,t,v){if(t!==true&&t!==false){console.warn("This cell is not a boolean value, it will be populated with 'false', cell=("+w+", "+u+")");f("#lookup-table").data("handsontable").setDataAtCell(w,u,false)}Handsontable.editors.CheckboxEditor.prototype.prepare.apply(this,arguments)};return this.forgiving_checkbox_editor},escapeHtmlRenderer:function(t,z,x,u,y,w,v){z.innerHTML=this.escapeHtml(Handsontable.helper.stringify(w));return z},renderLookup:function(w){if(w===null){this.showWarningMessage("Lookup could not be loaded");return}this.table_header=w[0];var u=null;if(this.lookup_type==="kv"){u={items:{row_above:{disabled:function(){return this.read_only||(f("#lookup-table").data("handsontable").getSelected()!==undefined&&f("#lookup-table").data("handsontable").getSelected()[0]===0)}},row_below:{disabled:function(){return this.read_only}},hsep1:"---------",remove_row:{disabled:function(){return this.read_only||(f("#lookup-table").data("handsontable").getSelected()!==undefined&&f("#lookup-table").data("handsontable").getSelected()[0]===0)}},hsep2:"---------",undo:{disabled:function(){return this.read_only}},redo:{disabled:function(){return this.read_only}}}}}else{u={items:{row_above:{disabled:function(){return this.read_only||(f("#lookup-table").data("handsontable").getSelected()!==undefined&&f("#lookup-table").data("handsontable").getSelected()[0]===0)}},row_below:{disabled:function(){return this.read_only}},hsep1:"---------",col_left:{disabled:function(){return this.read_only}},col_right:{disabled:function(){return this.read_only}},hsep2:"---------",remove_row:{disabled:function(){return this.read_only}},remove_col:{disabled:function(){return this.read_only}},hsep3:"---------",undo:{disabled:function(){return this.read_only}},redo:{disabled:function(){return this.read_only}}}}}var t=null;if(this.lookup_type==="kv"){f("#lookup-table").addClass("kv-lookup");t=this.getColumnsMetadata()}else{f("#lookup-table").addClass("csv-lookup")}if(w.length===1){this.addEmptyRows(w,w[0].length,5)}f("#lookup-table").handsontable({data:this.lookup_type==="kv"?w.slice(1):w,startRows:1,startCols:1,contextMenu:u,minSpareRows:0,minSpareCols:0,colHeaders:this.lookup_type==="kv"?this.table_header:false,columns:t,rowHeaders:true,fixedRowsTop:this.lookup_type==="kv"?0:1,height:function(){return f(window).height()-320},stretchH:"all",manualColumnResize:true,manualColumnMove:true,onBeforeChange:this.validate.bind(this),allowInsertColumn:this.lookup_type==="kv"?false:true,allowRemoveColumn:this.lookup_type==="kv"?false:true,renderer:this.lookupRenderer.bind(this),cells:function(z,x,A){var y={};if(this.read_only||(this.lookup_type==="kv"&&x==0)){y.readOnly=true}return y}.bind(this),beforeRemoveRow:function(y,z){if((this.countRows()-z)<=0){alert("A valid lookup file requires at least one row (for the header).");return false}if(y==0){var x=confirm("Are you sure you want to delete the header row?\n\nNote that a valid lookup file needs at least a header.");if(!x){return false}}},beforeRemoveCol:function(x,y){if((this.countCols()-y)<=0){alert("A valid lookup file requires at least one column.");return false}},afterRemoveCol:function(x,y){if(this.countCols()==0){alert("You must have at least one cell to have a valid lookup")}},afterColumnMove:function(){this.getTableHeader(false)}.bind(this)});var v=f("#lookup-table").data("handsontable");if(this.lookup_type==="kv"){v.addHook("afterChange",function(z,A){if(A==="key_update"){return}for(var C=0;C<z.length;C++){var B=z[C][0];var x=z[C][1];var y=z[C][3];this.doEditCell(B,x,y)}}.bind(this));v.addHook("beforeRemoveRow",function(x,y){for(var A=0;A<y;A++){var z=x+A;this.doRemoveRow(z)}}.bind(this));v.addHook("afterCreateRow",this.doCreateRows.bind(this))}},getParameterByName:function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var v=new RegExp("[\\?&]"+t+"=([^&#]*)"),u=v.exec(location.search);return u==null?"":decodeURIComponent(u[1].replace(/\+/g," "))},hide:function(t){t.css("display","none");t.addClass("hide")},unhide:function(t){t.removeClass("hide");t.removeAttr("style")},changeToEditMode:function(){f("#lookup-name-static",this.$el).text(this.lookup);this.unhide(f("#lookup-name-static",this.$el));this.hide(f(".show-when-creating",this.$el));f("h2",this.$el).text("Edit Lookup");this.is_new=false;var t="?lookup="+this.lookup+"&namespace="+this.namespace+"&type="+this.lookup_type;if(this.owner){t+="&owner="+this.owner}else{t+="&owner=nobody"}history.pushState(null,"Lookup Edit",t)},render:function(){this.lookup=this.getParameterByName("lookup");this.namespace=this.getParameterByName("namespace");this.owner=this.getParameterByName("owner");this.lookup_type=this.getParameterByName("type");this.is_new=false;if(this.lookup==""&&this.namespace==""&&this.owner==""){this.is_new=true}this.$el.html(r.template(s,{insufficient_permissions:false,is_new:this.is_new,lookup_name:this.lookup,lookup_type:this.lookup_type}));if(this.is_new){var t=new b({id:"lookup-name",searchWhenChanged:false,el:f("#lookup-name",this.$el)},{tokens:true}).render();t.on("change",function(x){this.validateForm()}.bind(this));var u=new g({id:"lookup-app",selectFirstChoice:false,showClearButton:false,el:f("#lookup-app",this.$el),choices:this.getAppsChoices()},{tokens:true}).render();u.on("change",function(x){this.validateForm()}.bind(this));var w=new j({id:"lookup-user-only",choices:[{label:"User-only",value:"user_only"}],el:f("#lookup-user-only")},{tokens:true}).render();w.on("change",function(x){this.validateForm()}.bind(this))}this.setupDragDropHandlers();if(this.lookup_type==="kv"&&!this.is_new){this.lookup_config=new e();this.lookup_config.fetch({url:d.fullpath(["/servicesNS","nobody",this.namespace,"storage/collections/config",this.lookup].join("/")),success:function(A,y,z){console.info("Successfully retrieved the information about the KV store lookup");for(var x in A.entry.associated.content.attributes){if(x.indexOf("field.")===0){this.field_types[x.substr(6)]=A.entry.associated.content.attributes[x]}}if(A.entry.associated.content.attributes.hasOwnProperty("enforceTypes")){if(A.entry.associated.content.attributes.enforceTypes==="true"){this.field_types_enforced=true}else{this.field_types_enforced=false}}if(!A.entry.acl.attributes.can_write){this.read_only=true;this.showWarningMessage("You do not have permission to edit this lookup; it is being displayed read-only")}}.bind(this),error:function(){console.warn("Unable to retrieve the information about the KV store lookup")}.bind(this),complete:function(){this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type)}.bind(this)})}else{if(this.lookup_type==="kv"&&this.is_new){this.kv_store_fields_editor=new o({el:f("#lookup-kv-store-edit",this.$el)});this.kv_store_fields_editor.render();f("#lookup-kv-store-edit",this.$el).show();f("#save",this.$el).show();f("#lookup-table",this.$el).hide()}else{if(this.is_new){var v=[["Column1","Column2","Column3","Column4","Column5","Column6"],["","","","","",""],["","","","","",""],["","","","","",""],["","","","","",""]];this.renderLookup(v)}else{if(this.lookup==""||this.namespace==""||this.owner==""){this.showWarningMessage("Not enough information to identify the lookup file to load")}else{this.loadLookupContents(this.lookup,this.namespace,this.owner,this.lookup_type)}}}}}});return p});
